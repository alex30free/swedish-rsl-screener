<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>RSL Strategy — 10-Year Backtest</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=IBM+Plex+Mono:wght@300;400;500;600&family=IBM+Plex+Sans:wght@300;400;600&display=swap" rel="stylesheet" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
  <style>
    :root {
      --bg:        #080c10;
      --surface:   #0d1318;
      --surface2:  #111c24;
      --border:    #1c2830;
      --border2:   #253340;
      --text:      #c8d8e8;
      --muted:     #4a6070;
      --muted2:    #6a8090;
      --accent:    #00e5a0;
      --accent2:   #0099ff;
      --gold:      #f0c040;
      --red:       #ff4455;
      --orange:    #ff8c42;
      --white:     #f0f4f8;
    }

    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    html { scroll-behavior: smooth; }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: 'IBM Plex Sans', sans-serif;
      font-weight: 300;
      min-height: 100vh;
      overflow-x: hidden;
    }

    body::before {
      content: '';
      position: fixed; inset: 0;
      background: repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(0,0,0,0.055) 2px, rgba(0,0,0,0.055) 4px);
      pointer-events: none; z-index: 9999;
    }
    body::after {
      content: '';
      position: fixed; inset: 0;
      background-image:
        linear-gradient(rgba(0,229,160,0.014) 1px, transparent 1px),
        linear-gradient(90deg, rgba(0,229,160,0.014) 1px, transparent 1px);
      background-size: 48px 48px;
      pointer-events: none; z-index: 0;
    }

    .glow {
      position: fixed; pointer-events: none; z-index: 0;
      border-radius: 50%;
    }
    .glow-1 {
      top: -160px; left: -160px; width: 600px; height: 600px;
      background: radial-gradient(circle, rgba(0,229,160,0.05) 0%, transparent 70%);
    }
    .glow-2 {
      bottom: -100px; right: -100px; width: 500px; height: 500px;
      background: radial-gradient(circle, rgba(0,153,255,0.04) 0%, transparent 70%);
    }

    .page {
      position: relative; z-index: 1;
      max-width: 1100px; margin: 0 auto;
      padding: 0 28px 100px;
    }

    /* ── HEADER ── */
    header {
      padding: 56px 0 44px;
      border-bottom: 1px solid var(--border);
      margin-bottom: 52px;
      animation: fadeDown .7s ease both;
    }
    .header-inner {
      display: flex; align-items: flex-end;
      justify-content: space-between; gap: 24px; flex-wrap: wrap;
    }
    .brand { display: flex; flex-direction: column; gap: 10px; }
    .brand-tag {
      font-family: 'IBM Plex Mono', monospace;
      font-size: 10px; font-weight: 500; letter-spacing: .28em;
      color: var(--accent); text-transform: uppercase;
      background: rgba(0,229,160,.07); border: 1px solid rgba(0,229,160,.18);
      padding: 4px 12px; display: inline-block; width: fit-content;
    }
    h1 {
      font-family: 'IBM Plex Mono', monospace;
      font-size: clamp(24px, 4vw, 40px); font-weight: 600;
      color: var(--white); line-height: 1.05; letter-spacing: -.03em;
    }
    h1 em { font-style: normal; color: var(--accent); }
    .brand-sub {
      font-family: 'IBM Plex Mono', monospace;
      font-size: 12px; color: var(--muted2); letter-spacing: .04em;
    }
    .header-right {
      font-family: 'IBM Plex Mono', monospace;
      font-size: 11px; color: var(--muted); text-align: right; line-height: 2;
    }
    .header-right .gen { color: var(--accent2); }

    /* ── BIAS WARNING ── */
    .bias-banner {
      background: rgba(255,140,66,.06);
      border: 1px solid rgba(255,140,66,.25);
      border-left: 3px solid var(--orange);
      padding: 16px 22px;
      margin-bottom: 44px;
      font-family: 'IBM Plex Mono', monospace; font-size: 12px;
      color: var(--orange); line-height: 1.7;
      animation: fadeDown .7s .05s ease both;
    }
    .bias-banner strong { color: #ffaa66; }

    /* ── STAT CARDS ── */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 1px;
      background: var(--border);
      border: 1px solid var(--border);
      margin-bottom: 44px;
      animation: fadeDown .7s .1s ease both;
    }
    @media (max-width: 700px) { .stats-grid { grid-template-columns: repeat(2, 1fr); } }

    .stat-block {
      background: var(--surface);
      padding: 24px 26px;
      position: relative; overflow: hidden;
    }
    .stat-block::after {
      content: '';
      position: absolute; top: 0; left: 0; right: 0; height: 2px;
      background: var(--accent); transform: scaleX(0); transform-origin: left;
      transition: transform .5s ease;
    }
    .stat-block:hover::after { transform: scaleX(1); }

    .stat-label {
      font-family: 'IBM Plex Mono', monospace;
      font-size: 10px; letter-spacing: .2em; text-transform: uppercase;
      color: var(--muted); margin-bottom: 10px;
    }
    .stat-main {
      font-family: 'Syne', sans-serif;
      font-size: 32px; font-weight: 800; line-height: 1;
      color: var(--white);
    }
    .stat-main.green  { color: var(--accent); }
    .stat-main.gold   { color: var(--gold); }
    .stat-main.red    { color: var(--red); }
    .stat-vs {
      font-family: 'IBM Plex Mono', monospace;
      font-size: 11px; color: var(--muted); margin-top: 6px;
    }
    .stat-vs .bm { color: var(--accent2); }

    /* ── CHART SECTION ── */
    .chart-section {
      margin-bottom: 44px;
      animation: fadeUp .7s .2s ease both;
    }
    .section-head {
      display: flex; align-items: center; justify-content: space-between;
      margin-bottom: 20px; flex-wrap: wrap; gap: 12px;
    }
    .section-title {
      font-family: 'IBM Plex Mono', monospace;
      font-size: 11px; font-weight: 500; letter-spacing: .2em;
      text-transform: uppercase; color: var(--muted2);
    }
    .legend {
      display: flex; gap: 20px;
      font-family: 'IBM Plex Mono', monospace; font-size: 11px;
    }
    .legend-item { display: flex; align-items: center; gap: 7px; }
    .legend-dot { width: 10px; height: 3px; border-radius: 2px; }
    .legend-dot.accent { background: var(--accent); }
    .legend-dot.blue   { background: var(--accent2); }

    .chart-wrap {
      background: var(--surface);
      border: 1px solid var(--border2);
      padding: 28px 24px 20px;
      position: relative;
    }
    .chart-wrap canvas { display: block; }

    /* ── ANNUAL TABLE ── */
    .annual-section {
      margin-bottom: 44px;
      animation: fadeUp .7s .3s ease both;
    }
    .annual-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 1px;
      background: var(--border);
      border: 1px solid var(--border);
    }
    .annual-card {
      background: var(--surface);
      padding: 20px 22px;
      position: relative;
    }
    .annual-year {
      font-family: 'Syne', sans-serif;
      font-size: 22px; font-weight: 800;
      color: var(--border2); margin-bottom: 14px;
    }
    .annual-row {
      display: flex; justify-content: space-between; align-items: center;
      font-family: 'IBM Plex Mono', monospace; font-size: 12px;
      margin-bottom: 6px;
    }
    .annual-row .lbl { color: var(--muted); font-size: 10px; letter-spacing: .1em; text-transform: uppercase; }
    .annual-row .val { font-weight: 500; }
    .val.pos   { color: var(--accent); }
    .val.neg   { color: var(--red); }
    .val.blue  { color: var(--accent2); }
    .alpha-bar {
      height: 3px; border-radius: 2px; margin-top: 12px;
      background: var(--border2); overflow: hidden;
    }
    .alpha-fill {
      height: 100%; border-radius: 2px;
      transition: width .6s ease;
    }
    .alpha-fill.pos { background: var(--accent); }
    .alpha-fill.neg { background: var(--red); }

    /* ── METRICS TABLE ── */
    .metrics-section {
      animation: fadeUp .7s .35s ease both;
      margin-bottom: 44px;
    }
    .metrics-grid {
      display: grid; grid-template-columns: 1fr 1fr; gap: 20px;
    }
    @media (max-width: 600px) { .metrics-grid { grid-template-columns: 1fr; } }

    .metrics-box {
      background: var(--surface);
      border: 1px solid var(--border2);
      padding: 28px 32px;
    }
    .metrics-box h3 {
      font-family: 'IBM Plex Mono', monospace;
      font-size: 10px; font-weight: 500; letter-spacing: .2em;
      text-transform: uppercase; margin-bottom: 20px;
    }
    .metrics-box.strategy h3 { color: var(--accent); border-left: 2px solid var(--accent); padding-left: 10px; }
    .metrics-box.benchmark h3 { color: var(--accent2); border-left: 2px solid var(--accent2); padding-left: 10px; }

    .metric-row {
      display: flex; justify-content: space-between; align-items: center;
      padding: 10px 0; border-bottom: 1px solid var(--border);
      font-family: 'IBM Plex Mono', monospace;
    }
    .metric-row:last-child { border-bottom: none; }
    .metric-row .ml { font-size: 12px; color: var(--muted2); }
    .metric-row .mv { font-size: 14px; font-weight: 500; color: var(--white); }

    /* ── METHODOLOGY NOTE ── */
    .method-note {
      background: var(--surface);
      border: 1px solid var(--border2);
      border-left: 3px solid var(--gold);
      padding: 28px 32px;
      animation: fadeUp .7s .4s ease both;
    }
    .method-note h3 {
      font-family: 'IBM Plex Mono', monospace;
      font-size: 11px; font-weight: 500; letter-spacing: .2em;
      text-transform: uppercase; color: var(--gold); margin-bottom: 16px;
    }
    .method-note p {
      font-size: 13px; color: var(--muted2); line-height: 1.75; margin-bottom: 10px;
    }
    .method-note p:last-child { margin-bottom: 0; }
    .method-note strong { color: var(--text); }

    /* ── NAV ── */
    .back-link {
      display: inline-flex; align-items: center; gap: 8px;
      font-family: 'IBM Plex Mono', monospace; font-size: 11px;
      color: var(--muted); text-decoration: none;
      border: 1px solid var(--border); padding: 8px 16px;
      transition: color .2s, border-color .2s;
      margin-bottom: 40px; margin-top: 20px;
      animation: fadeDown .7s ease both;
      display: block; width: fit-content;
    }
    .back-link:hover { color: var(--accent); border-color: var(--accent); }

    /* ── FOOTER ── */
    footer {
      margin-top: 60px; padding-top: 24px;
      border-top: 1px solid var(--border);
      font-family: 'IBM Plex Mono', monospace;
      font-size: 11px; color: var(--muted); line-height: 1.9;
      animation: fadeDown .7s .5s ease both;
    }

    /* ── LOADER ── */
    .loader {
      display: flex; align-items: center; justify-content: center;
      min-height: 400px; gap: 14px;
      font-family: 'IBM Plex Mono', monospace; font-size: 13px; color: var(--muted);
    }
    .spinner {
      width: 20px; height: 20px;
      border: 2px solid var(--border2); border-top-color: var(--accent);
      border-radius: 50%; animation: spin .8s linear infinite;
    }

    /* ── ANIMATIONS ── */
    @keyframes fadeDown { from { opacity:0; transform:translateY(-14px); } to { opacity:1; transform:translateY(0); } }
    @keyframes fadeUp   { from { opacity:0; transform:translateY(18px);  } to { opacity:1; transform:translateY(0); } }
    @keyframes spin     { to { transform: rotate(360deg); } }
  </style>
</head>
<body>
<div class="glow glow-1"></div>
<div class="glow glow-2"></div>

<div class="page">

  <a href="index.html" class="back-link">← Back to Live Screener</a>

  <!-- HEADER -->
  <header>
    <div class="header-inner">
      <div class="brand">
        <div class="brand-tag">Historical Backtest</div>
        <h1>RSL Strategy<br><em>10-Year Performance</em></h1>
        <div class="brand-sub">Top 20 by Levy RSL · Weekly rebalance · vs OMXSPI</div>
      </div>
      <div class="header-right">
        <div>Generated: <span class="gen" id="gen-date">—</span></div>
        <div id="period-display">Period: —</div>
        <div>Benchmark: OMXSPI (^OMX)</div>
        <div>Universe: Nasdaq Stockholm</div>
      </div>
    </div>
  </header>

  <div id="main-content">
    <div class="loader" id="loader">
      <div class="spinner"></div>
      Loading backtest results…
    </div>
  </div>

</div>

<script>
// ─────────────────────────────────────────────────────────────────────────────
// LOAD + RENDER
// ─────────────────────────────────────────────────────────────────────────────

async function loadData() {
  try {
    const res = await fetch('backtest_results.json?_=' + Date.now());
    if (!res.ok) throw new Error('HTTP ' + res.status);
    render(await res.json());
  } catch(e) {
    document.getElementById('loader').innerHTML =
      `<div style="color:var(--red);font-family:'IBM Plex Mono',monospace;font-size:13px;padding:40px;text-align:center;">
        ⚠ Could not load backtest_results.json<br><br>
        <span style="color:var(--muted);font-size:11px;">Run <strong style="color:var(--text)">python backtest.py</strong> first to generate results.</span>
      </div>`;
    console.error(e);
  }
}

function render(data) {
  const s     = data.stats || {};
  const curve = data.equity_curve || [];
  const annual = s.annual || [];

  // Header meta
  document.getElementById('gen-date').textContent = data.generated || '—';
  document.getElementById('period-display').textContent =
    `Period: ${data.period_start} → ${data.period_end}`;

  // Build page HTML
  const main = document.getElementById('main-content');
  main.innerHTML = buildPage(data, s, curve, annual);

  // Draw chart after DOM is ready
  requestAnimationFrame(() => {
    drawChart(curve);
    animateAlphaBars(annual);
  });
}

// ─────────────────────────────────────────────────────────────────────────────
// PAGE BUILDER
// ─────────────────────────────────────────────────────────────────────────────

function buildPage(data, s, curve, annual) {
  const portRet  = s.port_total_return;
  const bmRet    = s.bm_total_return;
  const alpha    = portRet != null && bmRet != null ? +(portRet - bmRet).toFixed(1) : null;

  return `
    <!-- BIAS WARNING -->
    <div class="bias-banner">
      ⚠ <strong>Survivorship Bias Warning</strong> — This backtest uses today's ticker universe only.
      Stocks that were delisted, went bankrupt, or were acquired during the period are <strong>not included</strong>.
      Returns are likely <strong>overstated</strong> compared to real-world performance.
      Treat these results as directional signal, not precise prediction.
    </div>

    <!-- STAT CARDS -->
    <div class="stats-grid">
      ${statBlock('Strategy Return', pct(portRet), 'green', `vs Benchmark: ${pct(bmRet, 'blue')}`)}
      ${statBlock('Strategy CAGR', pct(s.port_cagr), 'green', `Benchmark: ${pct(s.bm_cagr, 'blue')}`)}
      ${statBlock('Max Drawdown', pct(s.port_max_drawdown), 'red', `Benchmark: ${pct(s.bm_max_drawdown, null)}`)}
      ${statBlock('Sharpe Ratio', s.port_sharpe != null ? s.port_sharpe.toFixed(2) : '—', 'gold',
        `Win Rate: ${s.win_rate_pct != null ? s.win_rate_pct.toFixed(1)+'%' : '—'} of weeks`)}
    </div>

    <!-- EQUITY CURVE -->
    <div class="chart-section">
      <div class="section-head">
        <div class="section-title">Equity Curve — Portfolio Value (base 100)</div>
        <div class="legend">
          <div class="legend-item"><div class="legend-dot accent"></div><span style="color:var(--muted2)">RSL Strategy</span></div>
          <div class="legend-item"><div class="legend-dot blue"></div><span style="color:var(--muted2)">OMXSPI Benchmark</span></div>
        </div>
      </div>
      <div class="chart-wrap">
        <canvas id="equity-chart" height="320"></canvas>
      </div>
    </div>

    <!-- ANNUAL RETURNS -->
    <div class="annual-section">
      <div class="section-head">
        <div class="section-title">Annual Returns — Strategy vs Benchmark</div>
      </div>
      <div class="annual-grid">
        ${annual.map(row => buildAnnualCard(row)).join('')}
      </div>
    </div>

    <!-- METRICS DETAIL -->
    <div class="metrics-section">
      <div class="section-head" style="margin-bottom:16px;">
        <div class="section-title">Performance Metrics</div>
      </div>
      <div class="metrics-grid">
        <div class="metrics-box strategy">
          <h3>RSL Momentum Strategy</h3>
          ${metricRow('Total Return',    pct(s.port_total_return))}
          ${metricRow('CAGR',            pct(s.port_cagr))}
          ${metricRow('Max Drawdown',    pct(s.port_max_drawdown))}
          ${metricRow('Sharpe Ratio',    s.port_sharpe != null ? s.port_sharpe.toFixed(2) : '—')}
          ${metricRow('Weekly Win Rate', s.win_rate_pct != null ? s.win_rate_pct.toFixed(1) + '%' : '—')}
          ${metricRow('Portfolio Size',  data.portfolio_size + ' stocks')}
          ${metricRow('Rebalance',       'Weekly (Friday)')}
          ${metricRow('RSL Period',      data.rsl_period + ' trading days')}
        </div>
        <div class="metrics-box benchmark">
          <h3>OMXSPI Benchmark</h3>
          ${metricRow('Total Return',    pct(s.bm_total_return))}
          ${metricRow('CAGR',            pct(s.bm_cagr))}
          ${metricRow('Max Drawdown',    pct(s.bm_max_drawdown))}
          ${metricRow('Sharpe Ratio',    s.bm_sharpe != null ? s.bm_sharpe.toFixed(2) : '—')}
          ${metricRow('Index',           'OMX Stockholm All-Share')}
          ${metricRow('Ticker',          '^OMX (Yahoo Finance)')}
          ${metricRow('Alpha Generated', alpha != null ? (alpha >= 0 ? '+' : '') + alpha + '%' : '—')}
          ${metricRow('Period',          (s.n_years || '?') + ' years')}
        </div>
      </div>
    </div>

    <!-- METHOD NOTE -->
    <div class="method-note">
      <h3>Backtest Methodology</h3>
      <p>
        Each Friday (weekly rebalance), the screener ranks all Nasdaq Stockholm stocks (Large, Mid & Small Cap,
        excluding Financial sector, MCap &lt; 500M SEK) by their Levy RSL score —
        <strong>Current Price ÷ 130-day Simple Moving Average</strong>.
        The top 20 stocks by RSL are held in an <strong>equal-weighted portfolio</strong>
        until the following Friday, when the portfolio is rebalanced to the new top 20.
      </p>
      <p>
        Returns are calculated using adjusted close prices (splits and dividends included via Yahoo Finance
        auto-adjust). No transaction costs, taxes, or slippage are modelled — real-world returns
        would be lower. The benchmark is the <strong>OMXSPI (Stockholm All-Share Price Index)</strong>,
        also adjusted for corporate actions.
      </p>
      <p>
        <strong>Survivorship bias</strong> is the primary limitation: the ticker universe consists only of
        stocks currently listed on Nasdaq Stockholm. Companies that went bankrupt, were delisted, or were
        acquired during the backtest period are absent, which upwardly biases strategy returns.
        A conservative adjustment of <strong>1–3% per year</strong> downward is a reasonable correction
        for Swedish markets, though the true figure is unknown without a point-in-time index database.
      </p>
    </div>

    <footer>
      <p>Backtest generated: ${data.generated || '—'} · Period: ${data.period_start} → ${data.period_end}</p>
      <p style="margin-top:4px">RSL: R.A. Levy (1967) · Data: Yahoo Finance via yfinance · ⚠ Not financial advice</p>
    </footer>
  `;
}

// ─────────────────────────────────────────────────────────────────────────────
// CHART
// ─────────────────────────────────────────────────────────────────────────────

function drawChart(curve) {
  const canvas = document.getElementById('equity-chart');
  if (!canvas || !curve.length) return;

  // Thin out data points for performance — show ~200 points max
  const step  = Math.max(1, Math.floor(curve.length / 200));
  const thin  = curve.filter((_, i) => i % step === 0 || i === curve.length - 1);

  const labels = thin.map(p => p.date);
  const port   = thin.map(p => p.portfolio);
  const bm     = thin.map(p => p.benchmark);

  const ctx = canvas.getContext('2d');

  // Gradient fills
  const portGrad = ctx.createLinearGradient(0, 0, 0, 320);
  portGrad.addColorStop(0,   'rgba(0,229,160,0.18)');
  portGrad.addColorStop(1,   'rgba(0,229,160,0)');

  const bmGrad = ctx.createLinearGradient(0, 0, 0, 320);
  bmGrad.addColorStop(0,   'rgba(0,153,255,0.10)');
  bmGrad.addColorStop(1,   'rgba(0,153,255,0)');

  new Chart(ctx, {
    type: 'line',
    data: {
      labels,
      datasets: [
        {
          label:           'RSL Strategy',
          data:            port,
          borderColor:     '#00e5a0',
          borderWidth:     2,
          backgroundColor: portGrad,
          fill:            true,
          pointRadius:     0,
          tension:         0.3,
        },
        {
          label:           'OMXSPI Benchmark',
          data:            bm,
          borderColor:     '#0099ff',
          borderWidth:     1.5,
          backgroundColor: bmGrad,
          fill:            true,
          pointRadius:     0,
          tension:         0.3,
          borderDash:      [],
        },
      ],
    },
    options: {
      responsive:          true,
      maintainAspectRatio: false,
      interaction: { mode: 'index', intersect: false },
      plugins: {
        legend: { display: false },
        tooltip: {
          backgroundColor: '#0d1318',
          borderColor:     '#253340',
          borderWidth:     1,
          titleColor:      '#6a8090',
          bodyColor:       '#c8d8e8',
          titleFont:       { family: 'IBM Plex Mono', size: 10 },
          bodyFont:        { family: 'IBM Plex Mono', size: 12 },
          padding:         12,
          callbacks: {
            title: items => items[0].label,
            label: item => {
              const v = item.raw;
              const ret = ((v / 100) - 1) * 100;
              return ` ${item.dataset.label}: ${v.toFixed(1)}  (${ret >= 0 ? '+' : ''}${ret.toFixed(1)}%)`;
            },
          },
        },
      },
      scales: {
        x: {
          grid:   { color: 'rgba(255,255,255,0.03)' },
          ticks:  {
            color: '#4a6070', font: { family: 'IBM Plex Mono', size: 10 },
            maxTicksLimit: 10, maxRotation: 0,
          },
          border: { color: '#1c2830' },
        },
        y: {
          grid:   { color: 'rgba(255,255,255,0.04)' },
          ticks:  {
            color: '#4a6070', font: { family: 'IBM Plex Mono', size: 10 },
            callback: v => v.toFixed(0),
          },
          border: { color: '#1c2830' },
        },
      },
    },
  });
}

// ─────────────────────────────────────────────────────────────────────────────
// ANNUAL CARDS
// ─────────────────────────────────────────────────────────────────────────────

function buildAnnualCard(row) {
  const portCls  = row.portfolio >= 0 ? 'pos' : 'neg';
  const bmCls    = row.benchmark  >= 0 ? 'pos' : 'neg';
  const alphaCls = row.alpha      >= 0 ? 'pos' : 'neg';
  const sign     = v => (v >= 0 ? '+' : '') + v.toFixed(1) + '%';

  return `
    <div class="annual-card">
      <div class="annual-year">${row.year}</div>
      <div class="annual-row">
        <span class="lbl">Strategy</span>
        <span class="val ${portCls}">${sign(row.portfolio)}</span>
      </div>
      <div class="annual-row">
        <span class="lbl">Benchmark</span>
        <span class="val blue">${sign(row.benchmark)}</span>
      </div>
      <div class="annual-row">
        <span class="lbl">Alpha</span>
        <span class="val ${alphaCls}">${sign(row.alpha)}</span>
      </div>
      <div class="alpha-bar">
        <div class="alpha-fill ${alphaCls}" data-alpha="${row.alpha}" style="width:0%"></div>
      </div>
    </div>`;
}

function animateAlphaBars(annual) {
  const maxAbs = Math.max(...annual.map(r => Math.abs(r.alpha)), 1);
  document.querySelectorAll('.alpha-fill').forEach(el => {
    const alpha = parseFloat(el.dataset.alpha);
    const pct   = Math.min((Math.abs(alpha) / maxAbs) * 100, 100);
    setTimeout(() => { el.style.width = pct + '%'; }, 200);
  });
}

// ─────────────────────────────────────────────────────────────────────────────
// HELPERS
// ─────────────────────────────────────────────────────────────────────────────

function statBlock(label, value, cls, sub) {
  return `
    <div class="stat-block">
      <div class="stat-label">${label}</div>
      <div class="stat-main ${cls}">${value}</div>
      <div class="stat-vs">${sub}</div>
    </div>`;
}

function metricRow(label, value) {
  return `
    <div class="metric-row">
      <span class="ml">${label}</span>
      <span class="mv">${value}</span>
    </div>`;
}

function pct(v, cls) {
  if (v == null) return '—';
  const sign = v >= 0 ? '+' : '';
  const str  = `${sign}${v.toFixed(1)}%`;
  if (!cls) return str;
  const color = cls === 'blue' ? 'var(--accent2)' : cls === 'red' ? 'var(--red)' : 'var(--accent)';
  return `<span class="bm" style="color:${color}">${str}</span>`;
}

function esc(s) {
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

loadData();
</script>
</body>
</html>
